# TODO make this automatically generated by CatColab
""" Common types useful for deserializing CatColab JSON payloads """
module Types 

export ObType, MorType, DiagramObGenerator, DiagramMorGenerator, ObGenerator, 
       MorGenerator, Diagram, Model, ModelDiagram, Analysis

import JSON3: read
using StructTypes

struct ObType 
    tag::String 
    content::String
end
StructTypes.StructType(::Type{ObType}) = StructTypes.Struct()

Base.nameof(ob::ObType) = ob.tag

struct MorType 
    tag::String 
    content::Union{String,ObType}
end
StructTypes.StructType(::Type{MorType}) = StructTypes.Struct()

Base.nameof(mor::MorType) = mor.tag

struct DiagramObGenerator 
    id::String
    label::Vector{Union{Integer, String}}
    obType::ObType
    over::ObType
end 
StructTypes.StructType(::Type{DiagramObGenerator}) = StructTypes.Struct()

Base.nameof(dob::DiagramObGenerator) = join(string.(dob.label), ".")

struct DiagramMorGenerator
    id::String
    morType::MorType
    over::ObType
    dom::ObType
    cod::ObType
end
StructTypes.StructType(::Type{DiagramMorGenerator}) = StructTypes.Struct()

Base.nameof(dmor::DiagramMorGenerator) = join(string.(dmor.label), ".")

struct ObGenerator 
    id::String
    label::Vector{Union{Integer, String}}
    obType::ObType
end 
StructTypes.StructType(::Type{ObGenerator}) = StructTypes.Struct()

Base.nameof(obg::ObGenerator) = join(string.(obg.label), ".")

struct MorGenerator
    id::String
    label::Vector{Union{Integer, String}}
    morType::MorType
    dom::ObType
    cod::ObType
end
StructTypes.StructType(::Type{MorGenerator}) = StructTypes.Struct()

Base.nameof(morg::MorGenerator) = join(string.(morg.label), ".")

struct Diagram 
    obGenerators::Vector{DiagramObGenerator}
    morGenerators::Vector{DiagramMorGenerator}
end
StructTypes.StructType(::Type{Diagram}) = StructTypes.Struct()

struct Model 
    obGenerators::Vector{ObGenerator}
    morGenerators::Vector{MorGenerator}
end
StructTypes.StructType(::Type{Model}) = StructTypes.Struct()

struct ModelDiagram 
    model::Model
    diagram::Diagram
end
StructTypes.StructType(::Type{ModelDiagram}) = StructTypes.Struct()

# Intermediate variables enter as integers
struct Analysis
    model::Model
    diagram::Diagram
    analysis::Dict{Symbol, Any} 
end

function read(content::String, ::Type{Analysis})
    obj = read(content)
    model = StructTypes.constructfrom(Model, obj[:model])
    diagram = StructTypes.constructfrom(Diagram, obj[:diagram])
    Analysis(model, diagram, obj[:analysis]) 
end


end # module
